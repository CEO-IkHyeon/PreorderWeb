<!DOCTYPE html>
<html lang="ko">

    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 현황</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="print.css" media="print">

    <style>
        .order-detail-row {
            display: flex;
            justify-content: space-between;
        }
        
        .product-name, .quantity, .price {
            flex: 1;  /* 각 항목의 너비를 동일하게 만듭니다. */
            text-align: right;  /* 오른쪽 정렬 */
        }
        
        .product-name{
            text-align: left;  /* 제품 이름만 왼쪽 정렬 */
        }

        .border-line {
            border-bottom: 2px solid black; /* 바닥선 스타일 설정 */
            margin: 20px 0; /* 상하 여백 추가 */
        }
        .dotted-line {
            border-bottom: 1px dotted grey;
            margin: 20px 0;
        }

        


    </style>
</head>

<body>

    <div class="container mt-5">
        <h2>주문 현황</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>주문 번호</th>
                    <th>제품명</th>
                    <th>주문시간</th>
                    <th>픽업시간</th>
                    <th>가격</th>
                    <th>상태</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- 여기에 Firestore 데이터가 동적으로 삽입됩니다. -->
            </tbody>
        </table>
    </div>

    <!-- 주문 상세 정보 모달 -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailModalLabel">주문 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailContent" style="white-space: pre;">
                <!-- 주문 상세 내용이 여기에 동적으로 삽입됩니다. -->
                </div>
                <div class="modal-footer">
                    <!-- <button type="button" class="btn btn-secondary" onclick="printOrderDetail()">출력하기</button> -->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
  

        <!-- Firebase 설정 및 실시간 데이터 렌더링 코드 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

        <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <script>
        var firebaseConfig = {
        apiKey: "AIzaSyBfGzezMzKir_RRjstU0bUiSkCb8pjRQWE",
        authDomain: "preorder-d773a.firebaseapp.com",
        databaseURL: "https://preorder-d773a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "preorder-d773a",
        storageBucket: "preorder-d773a.appspot.com",
        messagingSenderId: "676616876310",
        appId: "1:676616876310:web:3b8a52fd360f80f4cbe037",
        measurementId: "G-JMRW6EP3ST"
        };

        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', function() {
            var tbody = document.querySelector('tbody');
            
            db.collection("orders").orderBy("timestamp", "desc").onSnapshot((querySnapshot) => {
                tbody.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    var order = doc.data();
                    var totalAdditionalItems = 0;  // Additional items counter
                    var firstProductName = "";      // First product name holder
                    
                    order.items.forEach((item, index) => {
                        // If it's the first item, save the product name
                        if(index === 0) {
                            firstProductName = item.productName;
                        } 
                        // Otherwise, add the quantity to the additional items counter
                        else {
                            totalAdditionalItems += item.quantity;
                        }
                    });
                    
                    
                    
                    // Construct button text and class based on status
                    var btnText = "접수하기";
                    var btnClass = "btn-primary";
                    var btnDisabled = "";
                    switch (order.status) {
                        case "ACCEPT":
                            btnText = "준비완료";
                            btnClass = "btn-warning";
                            break;
                        case "READY":
                            btnText = "픽업완료";
                            btnClass = "btn-success";
                            break;
                        case "FINISH":
                            btnText = "처리완료";
                            btnClass = "btn-light";
                            btnDisabled = "disabled";
                            break;
                        // ... other cases ...
                    }
                    
                    // Construct display text
                    var displayText = firstProductName;
                    if (totalAdditionalItems > 0) {
                        displayText += ` 외 ${totalAdditionalItems}개`;
                    }

                    // Calculate pickup time
                    var orderTime = order.timestamp.toDate();  // Convert to JavaScript Date object
                    var pickupTime = new Date(orderTime.getTime() + order.pickupTime * 60000);  // Add pickupTime minutes
                    var orderTimeStr = order.timestamp?.toDate().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) || "N/A";
                    var pickupTimeStr = pickupTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                    var priceStr = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(order.totalPrice);

                    // Build row for display...
                    var row = `
                        <tr>
                            <td>${order.orderId}</td>
                            <td>${displayText}</td>
                            <td>${orderTimeStr}</td>
                            <td>${pickupTimeStr}</td>
                            <td>${priceStr}</td>
                            <td>
                                <button class="btn ${btnClass} btn-sm" onclick="changeStatus(this, '${order.orderId}')" ${btnDisabled}>${btnText}</button>                            </td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="printReceipt('${order.orderId}')">영수증 출력</button>
                                <button class="btn btn-secondary btn-sm" onclick="viewDetails('${order.orderId}')">주문 상세</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        });

        // 상태 버튼 함수
        function changeStatus(btn, orderId) {
            console.log("changeStatus called with orderId:", orderId);

            // Find the document with the specified orderId in the orders collection
            db.collection("orders").where("orderId", "==", orderId).get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const currentStatus = doc.data().status;
                    let newStatus = '';
            
                    switch (currentStatus) {
                        case "ORDER":
                            newStatus = 'ACCEPT';
                            break;
                        case "ACCEPT":
                            newStatus = 'READY';
                            break;
                        case "READY":
                            newStatus = 'FINISH';
                            break;
                        default:
                            console.log("Unknown status: ", currentStatus);
                            return;
                    }

                    // Update Firestore document
                    doc.ref.update({
                        status: newStatus
                    }).then(() => {
                        console.log("Status updated successfully in Firestore for orderId:", orderId);
                    }).catch((error) => {
                        console.error("Error updating document: ", error);
                    });
                });
            }).catch((error) => {
                console.error("Error finding document: ", error);
            });
        }


        function printReceipt(orderId) {
            alert("영수증 출력하기");
            //viewDetails(orderId);
            // let printContents = document.getElementById('orderDetailContent').innerHTML;
            // let originalContents = document.body.innerHTML;

            // document.body.innerHTML = printContents;

            // window.print();

            // document.body.innerHTML = originalContents;
        }

        // function printOrderDetail() {
        //     let printContents = document.getElementById('orderDetailContent').innerHTML;
        //     let originalContents = document.body.innerHTML;

        //     document.body.innerHTML = printContents;

        //     window.print();

        //     document.body.innerHTML = originalContents;

        //     // Bootstrap 모달 초기화
        //     let modalElement = document.getElementById('orderDetailModal');
        //     let modal = new bootstrap.Modal(modalElement);
        //     modal.show();
        // }


        

        function viewDetails(orderId) {
            // Find the document with the specified orderId in the orders collection
            db.collection("orders").where("orderId", "==", orderId).get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const order = doc.data();

                    let orderDetailsHtml = "";
                    let total = 0;
                    let totalDrinks = 0;
                     
                    order.items.forEach((item, index) => {
                        let itemTotal = item.price * item.quantity;
                        totalDrinks += item.quantity;

                        orderDetailsHtml += `<div class="order-detail-row">
                            <div class="product-name">${item.productName}</div>
                            <div class="quantity">${item.quantity}</div>
                            <div class="price">${itemTotal.toLocaleString('ko-KR')}</div>
                        </div>`;


                        item.options.forEach(option => {
                            let optionTotal = option["가격"] * item.quantity;

                            orderDetailsHtml += `<div class="order-detail-row">
                                <div class="product-name">↳ ${option["옵션명"]}</div>
                                <div class="quantity">${item.quantity}</div>
                                <div class="price">${optionTotal.toLocaleString('ko-KR')}</div>
                            </div>`;

                            itemTotal += optionTotal;
                        });

                        total += itemTotal;
                        if (index !== order.items.length-1) {
                            orderDetailsHtml +=  `<div class="dotted-line"></div>`; 
                        }
                    });

                    orderDetailsHtml += `<div class="border-line"></div>`;
                    orderDetailsHtml += `<div class="order-detail-row">
                                            <div class="product-name">합계</div>
                                            <div class="quantity">${totalDrinks}</div>
                                            <div class="price">${total.toLocaleString('ko-KR')}</div>
                                        </div>`;

                    document.getElementById('orderDetailContent').innerHTML = orderDetailsHtml;
                    const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
                    modal.show();
                });
            }).catch((error) => {
                console.error("Error finding order details: ", error);
            });
        }






        
    </script>


</body>

</html>
