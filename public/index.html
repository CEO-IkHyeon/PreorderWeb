<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 현황</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <div class="container mt-5">
        <h2>주문 현황</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>주문 번호</th>
                    <th>제품명</th>
                    <th>주문시간</th>
                    <th>픽업시간</th>
                    <th>가격</th>
                    <th>상태</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- 여기에 Firestore 데이터가 동적으로 삽입됩니다. -->
            </tbody>
        </table>
    </div>

        <!-- Firebase 설정 및 실시간 데이터 렌더링 코드 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        var firebaseConfig = {
        apiKey: "AIzaSyBfGzezMzKir_RRjstU0bUiSkCb8pjRQWE",
        authDomain: "preorder-d773a.firebaseapp.com",
        databaseURL: "https://preorder-d773a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "preorder-d773a",
        storageBucket: "preorder-d773a.appspot.com",
        messagingSenderId: "676616876310",
        appId: "1:676616876310:web:3b8a52fd360f80f4cbe037",
        measurementId: "G-JMRW6EP3ST"
        };

        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', function() {
            var tbody = document.querySelector('tbody');
            
            db.collection("orders").orderBy("timestamp", "desc").onSnapshot((querySnapshot) => {
                tbody.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    var order = doc.data();
                    var totalAdditionalItems = 0;  // Additional items counter
                    var firstProductName = "";      // First product name holder
                    
                    order.items.forEach((item, index) => {
                        // If it's the first item, save the product name
                        if(index === 0) {
                            firstProductName = item.productName;
                        } 
                        // Otherwise, add the quantity to the additional items counter
                        else {
                            totalAdditionalItems += item.quantity;
                        }
                    });
                    
                    // Construct display text
                    var displayText = firstProductName;
                    if (totalAdditionalItems > 0) {
                        displayText += ` 외 ${totalAdditionalItems}개`;
                    }

                    // Calculate pickup time
                    var orderTime = order.timestamp.toDate();  // Convert to JavaScript Date object
                    var pickupTime = new Date(orderTime.getTime() + order.pickupTime * 60000);  // Add pickupTime minutes
                    var pickupTimeStr = pickupTime.toLocaleTimeString();  // Convert to time string
                    
                    // Construct button text and class based on status
                    var btnText = "접수하기";
                    var btnClass = "btn-primary";
                    var btnDisabled = "";
                    switch (order.status) {
                        case "ACCEPT":
                            btnText = "준비완료";
                            btnClass = "btn-warning";
                            break;
                        case "READY":
                            btnText = "픽업완료";
                            btnClass = "btn-success";
                            break;
                        case "FINISH":
                            btnText = "처리완료";
                            btnClass = "btn-light";
                            btnDisabled = "disabled";
                            break;
                        // ... other cases ...
                    }
                    
                
                    // Build row for display...
                    var row = `
                        <tr>
                            <td>${order.orderId}</td>
                            <td>${displayText}</td>
                            <td>${order.timestamp?.toDate().toLocaleTimeString() || "N/A"}</td>
                            <td>${pickupTimeStr}</td>
                            <td>${order.totalPrice}</td>
                            <td>
                                <button class="btn ${btnClass} btn-sm" onclick="changeStatus(this, '${order.orderId}')" ${btnDisabled}>${btnText}</button>                            </td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="printReceipt('${order.orderId}')">영수증 출력</button>
                                <button class="btn btn-secondary btn-sm" onclick="viewDetails('${order.orderId}')">주문 상세</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        });

        // 상태 버튼 함수
        function changeStatus(btn, orderId) {
            console.log("changeStatus called with orderId:", orderId);

            // Find the document with the specified orderId in the orders collection
            db.collection("orders").where("orderId", "==", orderId).get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const currentStatus = doc.data().status;
                    let newStatus = '';
            
                    switch (currentStatus) {
                        case "ORDER":
                            newStatus = 'ACCEPT';
                            break;
                        case "ACCEPT":
                            newStatus = 'READY';
                            break;
                        case "READY":
                            newStatus = 'FINISH';
                            break;
                        default:
                            console.log("Unknown status: ", currentStatus);
                            return;
                    }

                    // Update Firestore document
                    doc.ref.update({
                        status: newStatus
                    }).then(() => {
                        console.log("Status updated successfully in Firestore for orderId:", orderId);
                    }).catch((error) => {
                        console.error("Error updating document: ", error);
                    });
                });
            }).catch((error) => {
                console.error("Error finding document: ", error);
            });
        }




        function printReceipt(orderId) {
            alert("영수증 출력하기: " + orderId);
        }

        function viewDetails(orderId) {
            alert("주문 상세 : " + orderId);
        }
        
    </script>


</body>

</html>
