<!DOCTYPE html>
<html lang="ko">

    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 현황</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .order-detail-row {
            display: flex;
            justify-content: space-between;
        }
        
        .product-name, .quantity, .price {
            flex: 1;  /* 각 항목의 너비를 동일하게 만듭니다. */
            text-align: right;  /* 오른쪽 정렬 */
        }
        
        .product-name{
            text-align: left;  /* 제품 이름만 왼쪽 정렬 */
        }

        .border-line {
            border-bottom: 2px solid black; /* 바닥선 스타일 설정 */
            margin: 20px 0; /* 상하 여백 추가 */
        }
        .dotted-line {
            border-bottom: 1px dotted grey;
            margin: 20px 0;
        }

        


    </style>
</head>

<body>
    <div style="text-align: right; margin: 20px;">
        <button class="btn btn-danger" onclick="signOutUser()">로그아웃</button>
    </div>

    <div class="container mt-5">
        <h2>주문 현황</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>주문 번호</th>
                    <th>제품명</th>
                    <th>주문시간</th>
                    <th>픽업시간</th>
                    <th>가격</th>
                    <th>상태</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- 여기에 Firestore 데이터가 동적으로 삽입됩니다. -->
            </tbody>
        </table>
    </div>

    <!-- 주문 상세 정보 모달 -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailModalLabel">주문 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailContent" style="white-space: pre;">
                <!-- 주문 상세 내용이 여기에 동적으로 삽입됩니다. -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="printOrderDetails()">출력하기</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
  

        <!-- Firebase 설정 및 실시간 데이터 렌더링 코드 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

        <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <script>
        var firebaseConfig = {
        apiKey: "AIzaSyBfGzezMzKir_RRjstU0bUiSkCb8pjRQWE",
        authDomain: "preorder-d773a.firebaseapp.com",
        databaseURL: "https://preorder-d773a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "preorder-d773a",
        storageBucket: "preorder-d773a.appspot.com",
        messagingSenderId: "676616876310",
        appId: "1:676616876310:web:3b8a52fd360f80f4cbe037",
        measurementId: "G-JMRW6EP3ST"
        };

        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        const db = firebase.firestore();
        const auth = firebase.auth();


        document.addEventListener('DOMContentLoaded', function() {
            var tbody = document.querySelector('tbody');
            
            db.collection("orders").orderBy("timestamp", "desc").onSnapshot((querySnapshot) => {
                tbody.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    var order = doc.data();
                    var totalAdditionalItems = 0;  // Additional items counter
                    var firstProductName = "";      // First product name holder
                    
                    order.items.forEach((item, index) => {
                        // If it's the first item, save the product name
                        if(index === 0) {
                            firstProductName = item.productName;
                        } 
                        // Otherwise, add the quantity to the additional items counter
                        else {
                            // totalAdditionalItems += item.quantity;
                            totalAdditionalItems += 1;
                        }
                    });
                    
                    
                    
                    // Construct button text and class based on status
                    var btnText = "접수하기";
                    var btnClass = "btn-primary";
                    var btnDisabled = "";
                    switch (order.status) {
                        case "ACCEPTED":
                            btnText = "준비완료";
                            btnClass = "btn-warning";
                            break;
                        case "READY":
                            btnText = "픽업완료";
                            btnClass = "btn-success";
                            break;
                        case "FINISHED":
                            btnText = "처리완료";
                            btnClass = "btn-light";
                            btnDisabled = "disabled";
                            break;
                        // ... other cases ...
                    }
                    
                    // Construct display text
                    var displayText = firstProductName;
                    if (totalAdditionalItems > 0) {
                        displayText += ` 외 ${totalAdditionalItems}개`;
                    }

                    // Calculate pickup time
                    var orderTime = order.timestamp.toDate();  // Convert to JavaScript Date object
                    var pickupTime = new Date(orderTime.getTime() + order.pickupTime * 60000);  // Add pickupTime minutes
                    var orderTimeStr = order.timestamp?.toDate().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) || "N/A";
                    var pickupTimeStr = pickupTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                    var priceStr = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(order.totalPrice);

                    // Build row for display...
                    var row = `
                        <tr>
                            <td>${order.orderId}</td>
                            <td>${displayText}</td>
                            <td>${orderTimeStr}</td>
                            <td>${pickupTimeStr}</td>
                            <td>${priceStr}</td>
                            <td>
                                <button class="btn ${btnClass} btn-sm" onclick="changeStatus(this, '${order.orderId}')" ${btnDisabled}>${btnText}</button>                            </td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewDetails('${order.orderId}')">주문 상세</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        });

        // 상태 버튼 함수
        function changeStatus(btn, orderId) {
            //console.log("changeStatus called with orderId:", orderId);

            // Find the document with the specified orderId in the orders collection
            db.collection("orders").where("orderId", "==", Number(orderId)).get().then((querySnapshot) => {

                querySnapshot.forEach((doc) => {
                    const currentStatus = doc.data().status;
                    let newStatus = '';
            
                    switch (currentStatus) {
                        case "ORDER":
                            newStatus = 'ACCEPTED';
                            break;
                        case "ACCEPTED":
                            newStatus = 'READY';
                            break;
                        case "READY":
                            newStatus = 'FINISHED';
                            break;
                        default:
                            console.log("Unknown status: ", currentStatus);
                            return;
                    }

                    // Update Firestore document
                    doc.ref.update({
                        status: newStatus
                    }).then(() => {
                        console.log("Status updated successfully in Firestore for orderId:", orderId);
                    }).catch((error) => {
                        console.error("Error updating document: ", error);
                    });
                });
            }).catch((error) => {
                console.error("Error finding document: ", error);
            });
        }


        function printOrderDetails() {
            let printWindow = window.open('', '', 'width=600,height=600');
            printWindow.document.write('<html><head><title>Print</title>');
            // 여기에 필요한 CSS 파일 또는 스타일을 추가합니다.
            printWindow.document.write('</head><body>');
            printWindow.document.write(document.getElementById('orderDetailContent').innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }



        

        function viewDetails(orderId) {
            db.collection("orders").where("orderId", "==", Number(orderId)).get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const order = doc.data();

                    let orderDetailsHtml = "";
                    let total = 0;
                    let totalDrinks = 0;
                    let specialRequest = "";

                    // 주문번호 표시
                    orderDetailsHtml += `<div class="order-detail-row">
                        <div class="product-name">주문번호</div>
                        <div class="quantity"></div>
                        <div class="price">${orderId}</div>
                    </div>`;
                    orderDetailsHtml +=  `<div class="border-line"></div>`; 

                    // 픽업 시간 계산 및 표시
                    let pickupDate = new Date(order.timestamp.toDate());
                    pickupDate.setMinutes(pickupDate.getMinutes() + order.pickupTime);

                    let pickupTimeString = pickupDate.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' });  // 시간과 분만 표시

                    orderDetailsHtml += `<div class="order-detail-row">
                        <div class="product-name">픽업 시간</div>
                        <div class="quantity"></div>
                        <div class="price">${pickupTimeString}</div>
                    </div>`;
                    orderDetailsHtml +=  `<div class="border-line"></div>`; 
                    
                    // 요청사항 표시
                    specialRequest = order["specialRequest"]
                    orderDetailsHtml += `<div class="order-detail-row">
                        <div class="product-name">요청 사항</div>
                        <div class="quantity"></div>
                        <div class="price">${specialRequest}</div>
                    </div>`;
                    orderDetailsHtml +=  `<div class="border-line"></div>`; 

                    // 주문 내역 출력
                    order.items.forEach((item, index) => {
                        let itemTotal = item.productPrice * item.quantity;
                        totalDrinks += item.quantity;

                        orderDetailsHtml += `<div class="order-detail-row">
                            <div class="product-name">${item.productName}</div>
                            <div class="quantity">${item.quantity}</div>
                            <div class="price">${itemTotal.toLocaleString('ko-KR')}</div>
                        </div>`;


                        item.options.forEach(option => {
                            let optionTotal = option["optionPrice"] * item.quantity;

                            orderDetailsHtml += `<div class="order-detail-row">
                                <div class="product-name">↳ ${option["optionName"]}</div>
                                <div class="quantity">${item.quantity}</div>
                                <div class="price">${optionTotal.toLocaleString('ko-KR')}</div>
                            </div>`;

                            itemTotal += optionTotal;
                        });

                        total += itemTotal;
                        if (index !== order.items.length-1) {
                            orderDetailsHtml +=  `<div class="dotted-line"></div>`; 
                        }
                    });

                    orderDetailsHtml += `<div class="border-line"></div>`;
                    orderDetailsHtml += `<div class="order-detail-row">
                                            <div class="product-name">합계</div>
                                            <div class="quantity">${totalDrinks}</div>
                                            <div class="price">${total.toLocaleString('ko-KR')}</div>
                                        </div>`;

                    document.getElementById('orderDetailContent').innerHTML = orderDetailsHtml;
                    const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
                    modal.show();
                });
            }).catch((error) => {
                console.error("Error finding order details: ", error);
            });
        }

        function signOutUser() {
            auth.signOut().then(() => {
                alert(`성공적으로 로그아웃되었습니다.`);
                window.location.href = "login.html";
            }).catch((error) => {
                alert("로그아웃 중 문제가 발생했습니다. 다시 시도해주세요.");
                console.error("Error signing out: ", error);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Firebase 인증 상태 확인
            firebase.auth().onAuthStateChanged(user => {
                if (!user) {
                    // 사용자가 로그인하지 않은 경우 로그인 페이지로 리다이렉트
                    window.location.href = "login.html";
                }
            });
        });







        
    </script>


</body>

</html>
